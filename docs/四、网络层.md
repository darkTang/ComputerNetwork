# 四、网络层
网络层的主要任务是实现网络互联，进而实现数据包在各网络之间的传输。

## 1. 网络层提供的两种服务
### 1.1 面向连接的虚电路服务
- 可靠通信由网络来保证。
- 必须建立网络层连接——虚电路VC。
- 通信双方沿着已建立的虚电路发送分组。
- 目的主机的地址仅在连接建立阶段使用，之后每个分组的首部只需携带一条虛电路的编号 (构成虛电路的每一段链路都有一个虛电路编号)。
- 这种通信方式如果再使用可靠传输的网络协议，就可使所发送的分组最终正确到达接收方(无差错按序到达、不丟失、不重复)。
- 通信结束后，需要释放之前所建立的虚电路。
- 很多广域分组交换网都使用面向连接的虚电路服务。例如，普经的X.25和逐渐过时的帧中继FR、异步传输模式ATM等。

### 1.2 无连接的数据包服务(Internet采用的服务)&#x1F4A1;
- 可靠通信应当由用户主机来保证。
- 不需要建立网络层连接。
- 每个分组可走不同的路径。
- 每个分组的首部必须携带目的主机的完整地址。
- 这种通信方式所传送的分组可能误码、丟失、重复和失序。
- 由于网络本身不提供端到端的可靠传输服务，这就使网络中的路由器可以做得比较简单，而且价格低廉。
- 因特网采用了这种设计思想，也就是将复杂的网络处理功能置于因特网的边缘 (用户主机和其内部的运输层)，而将相对简单的尽最大努力的分组交付功能置于因特网核心。

## 2. IPv4地址
IPv4地址就是给因特网上的每一台主机(或路由器)的每一个接口分配一个在全世界范围内是唯一的32比特的标识符。

32比特的1PV4地址不方便阿读、记录以及输入等，因此IPV4地址采用点分十进制表示方法以方便用户使用。
> 32bit的IPv4地址：   00001010 11110000 00001111 10101010
> 
> 写成点分十进制形式:    10.240.15.240

### 2.1 分类编址的IPv4地址
![](https://rqm-1310837901.cos.ap-guangzhou.myqcloud.com/uPic/image-20230814114534775.png)
- 只有A类、B类和C类地址可分配给网络中的主机或路由器的各接口。
- 主机号为“全0”的地址是网络地址，不能分配给主机或路由器的各接口。
- 主机号为“全1”的地址是广播地址，不能分配给主机或路由器的各接口。

#### 2.1.1 A类地址
![](https://rqm-1310837901.cos.ap-guangzhou.myqcloud.com/uPic/image-20230814140606989.png)

#### 2.1.2 B类地址
![](https://rqm-1310837901.cos.ap-guangzhou.myqcloud.com/uPic/image-20230814141742625.png)

#### 2.1.3 C类地址
![](https://rqm-1310837901.cos.ap-guangzhou.myqcloud.com/uPic/image-20230814141645787.png)

> 地址0.0.0.0是一个特殊的1PV4地址，只能作为源地址使用，表示“在本网络上的本主机”封装有DHCP Discovery报文的1P分组的源地址使用0.0.0.0;
> 
> 以127开头且后面三个字节非“全0” 或“全7〞的1P地址是一类特殊的IPV4地 址，既可以作为源地址使用，也可以作为目的地址使用，用于本地软件环回测试，例如常用的环回测试地址 127.0.0.1;
> 
> 地址255.255.255.255 是一个特殊的1Pv4地址，只能作为目的地址使用，表示 “只在本网络上进行广播(各路由器均不转发)〞。

### 2.2 划分子网的IPv4地址
32比特的子网掩码可以表明分类IP地址的主机号部分被借用了几个比特作为子网号。
- 子网掩码使用连续的比特1来对应网络号和子网号。
- 子网掩码使用连续的比特0来对应主机号。
- 将划分子网的1PV4地址与其相应的子网掩码进行**逻辑与**运算就可得到IPv4地址所在子网的网络地址。
![](https://rqm-1310837901.cos.ap-guangzhou.myqcloud.com/uPic/image-20230814151453510.png)

举例：已知某个网络的地址为218.5.230.0，使用子网掩码255.255.255.128对其进行子网划分，请给出划分细节。
![](https://rqm-1310837901.cos.ap-guangzhou.myqcloud.com/uPic/image-20230814152205639.png)

> 默认的子网掩码是指在未划分子网的情况下使用的子网掩码。
>
> A类：255.0.0.0 
> 
> B类：255.255.0.0  
> 
> C类：255.255.255.0

### 2.3 无分类编址的IPv4地址
IDR使用“斜线记法”，或称CIDR记法。即在1Pv4地址后面加上斜线“/〞，在斜线后面 号上网络前綴所占的比特数量。
128.14.35.7/20 网络前缀占用的比特数量：20，主机编号占用的比特数量：32- 20 = 12

我们只要知道CIDR地址块中的任何一个地址，就可以知道该地址块的全部细节:
- 地址块的最小地址
- 地址块的最大地址
- 地址块中的地址数量
- 地址块聚合某类网络(A类、B类或C类)的数量 
- 地址掩码(也可继续称为子网掩码)

举例： 请给出CIDR地址块 128.14.35.7/20 的全部细节(最小地址，最大地址， 地址数量，聚合C类网数量，地址掩码)。
- 聚合C类网数量：地址数量 / C类网地址数量
![](https://rqm-1310837901.cos.ap-guangzhou.myqcloud.com/uPic/image-20230814161304539.png)

#### 2.3.1 路由聚合（构造超网）
- 网络前缀越长，地址块越小，路由越具体;
- 若路由器查表转发分组时发现有多条路由可选，则选择网络前缀最长的那条，这称为最长前缀匹配，因为这样的路由更具体。
- 聚合地址块：找到共同前缀，然后将剩下的比特全部置为0。
![](https://rqm-1310837901.cos.ap-guangzhou.myqcloud.com/uPic/image-20230814161939964.png)

### 2.4 IPv4地址的应用规划
- 定长的子网掩码
- 变长的子网掩码

