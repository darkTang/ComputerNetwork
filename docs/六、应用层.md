# 六、应用层
## 1. 客户/服务端方式（C/S方式）（Client/Server）
- C/S方式是因特网上传统的、同时也是最成熟的方式。服务器总是处于运行状态，并等待客户端的服务请求。
- 基于C/S方式的应用服务是服务集中的，因此会出现：服务器计算机跟不上众多客户端请求的情况。
- 因此，在C/S应用中，常用计算机集群构成一个强大的虚拟服务器。

## 2. 对等方式（P2P方式）（Peer-to-Peer）
- 在P2P方式中，没有固定的服务请求者和服务提供者，双方相互之间通信，被称为对等方，每个对等方既是服务的请求者也是服务的提供者。
- 目前，网上流行的P2P应用主要包括P2P文件共享、即时通信、P2P流媒体、分布式存储等。
- 可扩展性：系统性能不会因为规模的增大而增大，因为每增加一个对等方，会同时增加服务的请求者和服务的提供者。
- 成本低：不需要庞大的服务器设施和服务器带宽。

## 3. 动态主机配置协议（DHCP）
- DHCP 是基于UDP的应用层协议。
- 作用：帮助主机自动配置IP地址、子网掩码、默认网关、DNS服务器等信息。
- 每一台主机（0.0.0.0）都会向DHCP服务器发送广播请求（255.255.255.255）来请求主机配置信息。
- 地址0. 0. 0. 0是一个特殊的IPV4地址，只能作为源地址使用，可以表示 “在本网络上的任何主机”。
- 地址255. 255. 255. 255 是一个特殊的IPv4地址，只能作为目的地址使用，表示 “在本网络上的任何主机且只在本网络上进行广播 (各路由器均不转发)〞
- 若在本网络中没有DHCP服务器，那么主机是不能获得IP地址等配置信息的，需要在本网络的路由器配置其他网络的DHCP服务器IP地址才可以。

## 4. 域名系统DNS
- nic.hnust.edu.cn，从右到左分别为顶级域名、二级域名、三级域名...
- 根域名服务器
- 顶级域名服务器
- 权限域名服务器
- 本地域名服务器

### 4.1 域名解析过程
![](https://rqm-1310837901.cos.ap-guangzhou.myqcloud.com/uPic/image-20230809153751767.png)

### 4.2 实际的域名解析过程
先去查看浏览器缓存 -> 查看主机hosts文件 -> 查看本地域名服务器缓存 -> 迭代查询

## 5. 文件传送协议（FTP）
- 基于TCP的应用层协议。

## 6. 电子邮件
- 发送协议： SMTP（简单邮件传送协议）
- 读取协议：POP3、IMAP
- 都是基于TCP的应用层协议

## 7. HTTP协议
### 7.1 报文
- 请求报文
  - 请求行：请求method 请求url http协议版本
    - GET /api/queryUserInfo HTTP/1.1
  - 请求头
  - 请求体
  - 空行
- 响应报文
  - 状态行：http协议版本 状态码 状态码的描述
    - HTTP/1.1 200 OK
  - 响应头
  - 响应体
  - 空行

### 7.2 常见状态码
- 101 Switching Protocols 切换协议，只能切换到更高级的协议。
- 200 OK 请求成功。如果是非HEAD请求，服务器返回的响应头都会有body数据。
- 201 Created 常见成功。
- 204 No Content 请求成功。但响应头没有body数据。
- 206 Partial Content 是应用于HTTP**分块下载**或**断点续传**，表示响应返回的body数据并不完整，只是其中一部分。
- 301 Moved Permanently 表示资源永远重定向，说明请求的资源已经不存在了，需改用新的URL重新发送请求，也就是重定向。
- 302 Found 表示资源临时重定向，说明请求的资源还在，但暂时需要用另一个URL来访问。
- > 301和302都会在响应头里使用Location字段，指明后续要跳转的URL，浏览器会自动重定向到新的URL。
- 304 Not Modified 不具有跳转的含义，表示资源未修改，重定向已存在的缓存文件，也称缓存重定向，告诉客户端可以继续使用缓存资源，用于缓存控制。（协商缓存）
- 400 Bad Request 表示客户端请求报文有错误，服务器无法理解。
- 401 Unauthorized 请求要求用户的身份认证。
- 403 Forbidden 表示服务器禁止访问资源，并不是客户端请求出错。
- 404 Not Found 表示请求的资源在服务器上不存在或未找到。
- 408 Request Time-out 服务器等待客户端发送的请求时间过长，超时。
- 500 Internal Server Error 服务器内部发生错误。

### 7.3 缓存技术&#x1F680;
- 强制缓存：不会向服务器发送请求，直接从缓存中读取资源，在chrome浏览器可以看到会返回200的状态码。
  - 通过响应头的`Expires`和`Cache-Control`来实现的。
  - 服务器通过`Expires`设置过期时间，如`Expires: Wed, 21 Jul 2021 07:00:00 GMT`当浏览器再次加载资源时，如果在这个时间内，则命中强缓存。
  - `Cache-Control`当值设置为max-age=300时，则代表这个请求正确返回时间的5分钟内再次加载资源，就会命中强缓存。除了该字段外，还有几个常用字段：
    1. no-cache：使用协商缓存。
    2. no-store：不缓存。
    3. public：可以被所有用户缓存，包括终端用户和CDN等中间代理服务器。
    4. private：只能被终端用户的浏览器缓存，不允许CDN等中间代理服务器对其缓存。
  > Expires与系统时间有关，现在基本上不常用。
  >
  > max-age设置以秒为单位的过期时间。
  >
  > Expires优先级比Cache-Control低，同时设置，则Cache-Control生效。
  >
  > Expires设置的是一个绝对时间，而Cache-Control设置的是一个相对时间。
- 协商缓存：会向服务器发送请求，服务器会告诉浏览器是否可以使用本地缓存的资源，如果可以，则会返回状态码304。
  - `Last-Modified/If-Modified-Since`：浏览器第一次请求一个资源时，服务器返回的header中会加上Last-Modified，Last-Modified是一个时间标识该资源的最后修改时间；当浏览器再次请求该资源时，request的请求头中会包含 If-Modified-Since字段，该值就是Last-Modified的值。服务器收到If-Modified-Since之后，根据资源的最后修改时间判断是否命中缓存，如果服务器发现资源的最后修改时间早于或等于 If-Modified-Since 值，则说明资源未更改，可以返回 304 Not Modified 响应，客户端可以使用缓存的版本。否则，服务器将返回新的资源，客户端需要更新缓存。日期格式类似于`Last-Modified: Fri, 12 May 2006 18:53:33 GMT`
  - `Etag/If-None-Match`：web服务器响应请求时，告诉浏览器当前资源在服务器的唯一标识（生成规则由服务器决定）。当浏览器再次请求该资源时，request的请求头中会包含 If-None-Match字段，该值就是Etag的值。服务器收到If-None-Match之后，hash值对比判断是否命中缓存，若二者一致，说明浏览器资源未被修改，则直接走缓存，返回304；若二者不一致，说明浏览器资源被修改了，则会重新请求。
  > Etag要优于Last-Modified。Last-Modified，Last-Modified 和 If-Modified-Since 只能精确到秒级别，如果某个文件1秒内改变了多次，则无法区分这些修改，但是Etag每次改变都会重新生成。
  >
  > 在性能上，Etag要逊色于Last-Modified，毕竟Last-Modified只需要记录时间，而Etag需要服务器通过算法来计算出一个hash值，增大了服务器的开销。
  >
  > 在优先级上，服务器校验优先考虑Etag。

### 7.4 特性
目前我们常用的是HTTP/1.1，这里的特性以HTTP/1.1为例。
- 优点
  - 简单
  - 灵活且易于扩展
  - 应用广泛和跨平台
- 缺点
  - 无状态
  - 明文传输
  - 不安全
    - 明文传输(不加密)，窃听风险。
    - 不验证通信方的身份，冒充风险。
    - 不验证报文的完整性，篡改风险。

### 7.5 演变
#### 7.5.1 HTTP/1.0
HTTP/1.0 性能上的一个很大的问题，那就是每发起一个请求，都要新建一次 TCP 连接（三次握手），而且是串行请求，做了无谓的 TCP 连接建立和断开，增加了通信开销。

#### 7.5.2 HTTP/1.1
- 长连接
- 管道传输
  - 优点在于同一个 TCP 连接里面，客户端可以发起多个请求，只要第一个请求发出去了，不必等其回来，就可以发第二个请求出去，可以减少整体的响应时间。
  - 缺点就是服务器必须按照接收请求的顺序发送对这些管道化请求的响应。
  - HTTP/1.1 管道解决了请求的队头阻塞，但是没有解决响应的队头阻塞。
- 一问一答：请求只能从客户端开始，服务器只能被动响应。

#### 7.5.3 HTTP/2.0
![](https://rqm-1310837901.cos.ap-guangzhou.myqcloud.com/uPic/image-20230810151853576.png)
- 头部压缩
- 二进制格式
- 并发传输
- 服务器主动推送资源

#### 7.5.4 HTTP/3.0
![](https://rqm-1310837901.cos.ap-guangzhou.myqcloud.com/uPic/image-20230810152804686.png)
- 无队头阻塞
- 更快的连接建立
- 连接迁移：当移动设备的网络从 4G 切换到 WIFI 时，意味着 IP 地址变化了，那么就必须要断开连接，然后重新建立连接。而建立连接的过程包含 TCP 三次握手和 TLS 四次握手的时延，以及 TCP 慢启动的减速过程，给用户的感觉就是网络突然卡顿了一下，因此连接的迁移成本是很高的。而 QUIC 协议没有用四元组的方式来“绑定”连接，而是通过连接 ID 来标记通信的两个端点，客户端和服务器可以各自选择一组 ID 来标记自己，因此即使移动设备的网络变化后，导致 IP 地址变化了，只要仍保有上下文信息（比如连接 ID、TLS 密钥等），就可以“无缝”地复用原连接，消除重连的成本，没有丝毫卡顿感，达到了连接迁移的功能。

## 8. HTTPS协议
- HTTPS在 TCP 和 HTTP 网络层之间加入了 SSL/TLS 安全协议，使得报文能够加密传输。
- HTTPS 在 TCP 三次握手之后，还需进行 SSL/TLS 的握手过程，才可进入加密报文传输。

HTTPS解决了HTTP/1.1存在的风险。
- 信息加密(混合加密)解决窃听风险。
- 校验机制(摘要算法)解决篡改风险。
- 身份证书(数字证书)解决冒充风险。